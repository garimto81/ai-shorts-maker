<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자동차 휠 복원 AI 쇼츠 제작기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif; background: linear-gradient(135deg, #1f2937 0%, #111827 100%); min-height: 100vh; }
        .image-thumb { width: 80px; height: 80px; border-radius: 8px; overflow: hidden; position: relative; border: 2px solid #4B5563; cursor: pointer; transition: all 0.3s ease; }
        .image-thumb:hover { border-color: #10B981; transform: scale(1.05); }
        .image-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .image-order { position: absolute; top: -8px; left: -8px; background: #10B981; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; }
        .progress-bar { width: 100%; height: 8px; background-color: #374151; border-radius: 4px; overflow: hidden; margin: 16px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10B981, #3B82F6); border-radius: 4px; transition: width 0.5s ease; width: 0%; }
    </style>
</head>
<body class="text-white">
    <div class="px-4 py-6 text-center">
        <div class="flex items-center justify-center mb-2">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                <span class="text-2xl">🛞</span>
            </div>
            <div>
                <h1 class="text-2xl font-bold">자동차 휠 복원</h1>
                <h2 class="text-lg text-blue-400">AI 쇼츠 제작기</h2>
            </div>
        </div>
        <p class="text-sm text-gray-400">휠 복원 과정을 전문적인 홍보 쇼츠로 변환합니다</p>
    </div>

    <div class="px-4 mb-6">
        <div class="bg-gray-800 rounded-lg p-4">
            <div class="text-sm font-medium text-gray-300 mb-2">진행 상황</div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-500">
                <span>0%</span>
                <span id="progressText">대기 중</span>
                <span>100%</span>
            </div>
        </div>
    </div>

    <div class="px-4 space-y-6">
        <div class="bg-gray-800 rounded-lg p-4">
            <label class="block text-sm font-medium mb-3 text-gray-300">🚗 휠 정보</label>
            <input 
                type="text" 
                id="wheelInfo" 
                placeholder="예: BMW 18인치 알로이 휠, 스크래치 복원 작업"
                class="w-full px-3 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500"
            >
        </div>

        <div class="bg-gray-800 rounded-lg p-4">
            <label class="block text-sm font-medium mb-3 text-gray-300">📸 작업 과정 사진 업로드</label>
            <input 
                type="file" 
                id="imageInput" 
                multiple 
                accept="image/*"
                class="w-full px-3 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700"
            >
            <p class="text-xs text-gray-500 mt-2">작업 전후, 과정 사진 등을 자유롭게 업로드하세요 (장수 제한 없음)</p>
            
            <div id="imagePreview" class="hidden mt-4">
                <div class="flex flex-wrap gap-2" id="imageContainer"></div>
                <div class="mt-2 text-xs text-gray-400">
                    <span id="imageCount">0</span>장의 이미지가 업로드되었습니다
                </div>
            </div>
        </div>

        <button 
            id="startProcessBtn" 
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300 disabled:opacity-50"
            disabled
        >
            🚀 AI 분석 시작
        </button>

        <div id="status" class="bg-gray-700 rounded-lg p-4 text-center text-gray-300 border border-gray-600">
            <div id="statusText">휠 정보와 사진을 업로드하고 AI 분석을 시작하세요</div>
        </div>

        <div id="sortedSection" class="hidden bg-gray-800 rounded-lg p-4">
            <div class="text-sm font-medium mb-3 text-green-400">✅ AI가 분석한 최적 순서</div>
            <div id="sortedImages" class="flex flex-wrap gap-2"></div>
        </div>

        <div id="analysisSection" class="hidden bg-gray-800 rounded-lg p-4">
            <div class="text-sm font-medium mb-3 text-blue-400">🔍 이미지 분석 결과</div>
            <div id="analysisResults" class="space-y-2"></div>
        </div>

        <button 
            id="generateVideoBtn" 
            class="hidden w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-4 px-6 rounded-lg"
        >
            🎬 쇼츠 비디오 생성
        </button>

        <div id="downloadSection" class="hidden bg-green-800 rounded-lg p-4">
            <div class="text-center">
                <div class="text-lg font-bold mb-2">🎉 완성!</div>
                <p class="text-sm text-green-200 mb-4">휠 복원 쇼츠가 성공적으로 생성되었습니다</p>
                <a id="downloadLink" class="inline-block bg-white text-green-800 font-bold py-3 px-6 rounded-lg">📥 비디오 다운로드</a>
            </div>
        </div>
    </div>

    <script>
        let uploadedImages = [];
        let sortedImages = [];
        let analysisResults = [];

        const elements = {
            wheelInfo: document.getElementById('wheelInfo'),
            imageInput: document.getElementById('imageInput'),
            imagePreview: document.getElementById('imagePreview'),
            imageContainer: document.getElementById('imageContainer'),
            imageCount: document.getElementById('imageCount'),
            startBtn: document.getElementById('startProcessBtn'),
            videoBtn: document.getElementById('generateVideoBtn'),
            status: document.getElementById('statusText'),
            progress: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            sortedSection: document.getElementById('sortedSection'),
            sortedImages: document.getElementById('sortedImages'),
            analysisSection: document.getElementById('analysisSection'),
            analysisResults: document.getElementById('analysisResults'),
            downloadSection: document.getElementById('downloadSection'),
            downloadLink: document.getElementById('downloadLink')
        };

        elements.wheelInfo.addEventListener('input', checkInputs);
        elements.imageInput.addEventListener('change', handleImageUpload);
        elements.startBtn.addEventListener('click', startAIProcess);
        elements.videoBtn.addEventListener('click', generateVideo);

        function checkInputs() {
            const hasInfo = elements.wheelInfo.value.trim().length > 0;
            const hasImages = uploadedImages.length > 0;
            elements.startBtn.disabled = !(hasInfo && hasImages);
            if (hasInfo && hasImages) showStatus('모든 정보가 입력되었습니다. AI 분석을 시작하세요!');
        }

        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            uploadedImages = [];
            elements.imageContainer.innerHTML = '';

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImages.push({ name: file.name, dataUrl: e.target.result, file: file });
                    
                    const thumbDiv = document.createElement('div');
                    thumbDiv.className = 'image-thumb';
                    thumbDiv.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <div class="image-order">${index + 1}</div>
                        <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-1 text-center">
                            ${file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name}
                        </div>
                    `;
                    elements.imageContainer.appendChild(thumbDiv);

                    if (uploadedImages.length === files.length) {
                        elements.imagePreview.classList.remove('hidden');
                        elements.imageCount.textContent = uploadedImages.length;
                        checkInputs();
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function showStatus(msg) { elements.status.textContent = msg; }
        function updateProgress(pct) {
            elements.progress.style.width = pct + '%';
            elements.progressText.textContent = pct + '%';
        }

        async function startAIProcess() {
            try {
                elements.startBtn.disabled = true;
                showStatus('AI 분석을 시작합니다...');
                updateProgress(10);

                await step1_sort();
                updateProgress(40);
                await step2_analyze();
                updateProgress(80);
                await step3_story();
                updateProgress(100);

                elements.videoBtn.classList.remove('hidden');
                showStatus('✅ AI 분석 완료! 쇼츠 비디오를 생성할 수 있습니다.');
            } catch (error) {
                showStatus('❌ 오류: ' + error.message);
                elements.startBtn.disabled = false;
            }
        }

        async function step1_sort() {
            showStatus('🔍 파일명 분석 및 최적 순서 결정 중...');
            const formData = new FormData();
            formData.append('filenames', JSON.stringify(uploadedImages.map(img => img.name)));
            formData.append('wheelInfo', elements.wheelInfo.value);

            const response = await fetch('/api/sort-filenames', { method: 'POST', body: formData });
            const result = await response.json();
            if (result.error) throw new Error(result.error);

            const order = result.data?.sortedOrder || result.order;
            sortedImages = order ? order.map(i => uploadedImages[i]) : uploadedImages;

            elements.sortedImages.innerHTML = '';
            sortedImages.forEach((img, i) => {
                const div = document.createElement('div');
                div.className = 'image-thumb';
                div.innerHTML = `<img src="${img.dataUrl}"><div class="image-order">${i + 1}</div>`;
                elements.sortedImages.appendChild(div);
            });
            elements.sortedSection.classList.remove('hidden');
        }

        async function step2_analyze() {
            showStatus('🔍 이미지 정밀 분석 중...');
            analysisResults = [];
            elements.analysisResults.innerHTML = '';

            for (let i = 0; i < sortedImages.length; i++) {
                showStatus(`🔍 이미지 ${i + 1}/${sortedImages.length} 분석 중...`);
                const formData = new FormData();
                formData.append('image', dataURLtoBlob(sortedImages[i].dataUrl), sortedImages[i].name);
                formData.append('wheelInfo', elements.wheelInfo.value);

                const response = await fetch('/api/analyze-image', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.error) throw new Error(result.error);

                analysisResults.push({ image: sortedImages[i], analysis: result.data || result });
                
                const div = document.createElement('div');
                div.className = 'bg-gray-700 rounded p-3 text-sm';
                div.innerHTML = `
                    <div class="font-semibold text-blue-300 mb-1">${i + 1}. ${sortedImages[i].name}</div>
                    <div class="text-gray-300">${result.data?.description || result.description || '분석 완료'}</div>
                `;
                elements.analysisResults.appendChild(div);
            }
            elements.analysisSection.classList.remove('hidden');
        }

        async function step3_story() {
            showStatus('📝 나레이션 생성 중...');
            const payload = {
                wheelInfo: elements.wheelInfo.value,
                analysisResults: analysisResults,
                industry: 'wheel-restoration'
            };

            const response = await fetch('/api/generate-narration', { 
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.error) throw new Error(result.error);
        }

        async function generateVideo() {
            try {
                elements.videoBtn.disabled = true;
                showStatus('🎬 쇼츠 비디오 생성 중...');

                const formData = new FormData();
                formData.append('wheelInfo', elements.wheelInfo.value);
                sortedImages.forEach((img, i) => {
                    formData.append('images', dataURLtoBlob(img.dataUrl), `image_${i}.jpg`);
                });

                const response = await fetch('/api/generate-video', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.error) throw new Error(result.error);

                elements.downloadLink.href = result.videoUrl;
                elements.downloadLink.download = result.filename || 'wheel-restoration-shorts.mp4';
                elements.downloadSection.classList.remove('hidden');
                showStatus('🎉 휠 복원 쇼츠가 완성되었습니다!');
            } catch (error) {
                showStatus('❌ 비디오 생성 오류: ' + error.message);
                elements.videoBtn.disabled = false;
            }
        }

        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            const u8arr = new Uint8Array(bstr.length);
            for (let i = 0; i < bstr.length; i++) u8arr[i] = bstr.charCodeAt(i);
            return new Blob([u8arr], { type: mime });
        }
    </script>
</body>
</html>