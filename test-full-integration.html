<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Shorts Maker - 전체 통합 테스트</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .workflow {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .step {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .step:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }
        
        .step h2 {
            color: #2196F3;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-number {
            background: #2196F3;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
            width: 100%;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result-box {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result-box pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
        }
        
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .loading {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        audio, video {
            width: 100%;
            margin-top: 10px;
            border-radius: 6px;
        }
        
        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            background: #2196F3;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pending { background: #999; }
        .status-processing { background: #ff9800; }
        .status-completed { background: #4CAF50; }
        .status-error { background: #f44336; }
        
        .test-samples {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 6px;
        }
        
        .sample-button {
            background: #2196F3;
            margin: 5px;
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            display: inline-block;
        }
        
        .sample-button:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 AI Shorts Maker - 전체 통합 테스트</h1>
        
        <div class="workflow">
            <!-- Step 1: 스크립트 생성 -->
            <div class="step" id="step1">
                <h2>
                    <span class="step-number">1</span>
                    스크립트 생성
                </h2>
                
                <div class="form-group">
                    <label for="scriptTitle">제목</label>
                    <input type="text" id="scriptTitle" value="AI가 만드는 놀라운 쇼츠 영상">
                </div>
                
                <div class="form-group">
                    <label for="scriptContent">내용</label>
                    <textarea id="scriptContent">안녕하세요! 오늘은 AI로 만든 놀라운 쇼츠 영상을 소개합니다. 정말 신기하고 재미있는 기술이에요! 여러분도 쉽게 만들 수 있답니다. 지금 바로 시작해보세요!</textarea>
                </div>
                
                <div class="form-group">
                    <label for="videoStyle">비디오 스타일</label>
                    <select id="videoStyle">
                        <option value="promotional">홍보 (활기찬)</option>
                        <option value="educational">교육 (친근한)</option>
                        <option value="entertainment">엔터테인먼트 (신나는)</option>
                        <option value="documentary">다큐멘터리 (차분한)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="generateAudio" checked>
                        활기찬 음성 자동 생성
                    </label>
                </div>
                
                <button onclick="generateScript()">스크립트 생성</button>
                
                <div class="test-samples">
                    <h4>테스트 샘플:</h4>
                    <button class="sample-button" onclick="loadSample('product')">신제품 소개</button>
                    <button class="sample-button" onclick="loadSample('tutorial')">튜토리얼</button>
                    <button class="sample-button" onclick="loadSample('event')">이벤트 홍보</button>
                </div>
                
                <div id="scriptResult" class="result-box" style="display: none;"></div>
            </div>
            
            <!-- Step 2: 음성 확인 -->
            <div class="step" id="step2">
                <h2>
                    <span class="step-number">2</span>
                    음성 확인
                </h2>
                
                <div id="audioSection" style="display: none;">
                    <p><strong>생성된 음성:</strong></p>
                    <p id="voiceInfo"></p>
                    <audio id="audioPlayer" controls></audio>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>음성 만족도</label>
                        <select id="audioSatisfaction">
                            <option value="perfect">완벽해요! 🎉</option>
                            <option value="good">좋아요 👍</option>
                            <option value="regenerate">다시 생성할게요 🔄</option>
                        </select>
                    </div>
                    
                    <button onclick="regenerateAudio()" id="regenerateBtn" style="display: none;">다른 스타일로 재생성</button>
                </div>
                
                <div id="audioStatus" class="loading" style="display: none;">음성을 생성하고 있습니다...</div>
            </div>
            
            <!-- Step 3: 비디오 생성 -->
            <div class="step" id="step3">
                <h2>
                    <span class="step-number">3</span>
                    비디오 생성
                </h2>
                
                <div class="form-group">
                    <label for="testImages">테스트 이미지 선택</label>
                    <select id="testImages">
                        <option value="nature">자연 풍경 (5장)</option>
                        <option value="tech">기술/IT (5장)</option>
                        <option value="food">음식 (5장)</option>
                        <option value="abstract">추상적 이미지 (5장)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="videoQuality">비디오 품질</label>
                    <select id="videoQuality">
                        <option value="high">고품질 (1080p)</option>
                        <option value="medium" selected>중간 (720p)</option>
                        <option value="low">저품질 (540p)</option>
                    </select>
                </div>
                
                <button onclick="generateVideo()" id="generateVideoBtn" disabled>비디오 생성</button>
                
                <div class="progress-bar" id="videoProgress" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div id="videoResult" style="display: none;">
                    <video id="videoPlayer" controls></video>
                    <div id="videoInfo"></div>
                </div>
            </div>
        </div>
        
        <!-- 전체 상태 표시 -->
        <div class="step" style="grid-column: 1 / -1;">
            <h2>📊 전체 진행 상태</h2>
            <div id="overallStatus">
                <p><span class="status-indicator status-pending"></span>스크립트 생성: <span id="scriptStatus">대기 중</span></p>
                <p><span class="status-indicator status-pending"></span>음성 생성: <span id="audioGenerationStatus">대기 중</span></p>
                <p><span class="status-indicator status-pending"></span>비디오 렌더링: <span id="videoStatus">대기 중</span></p>
            </div>
            
            <div id="finalResult" style="margin-top: 20px; display: none;">
                <h3>🎉 최종 결과</h3>
                <div id="finalInfo"></div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentScript = null;
        let currentAudio = null;
        let currentVideo = null;

        // 샘플 데이터
        const sampleScripts = {
            product: {
                title: "혁신적인 AI 스마트워치 출시!",
                content: "드디어 공개합니다! 당신의 일상을 바꿀 AI 스마트워치! 건강 관리부터 일정 관리까지, 모든 것을 한 번에! 놓치면 후회하는 특별 할인 이벤트! 지금 바로 만나보세요!"
            },
            tutorial: {
                title: "5분만에 배우는 영상 편집",
                content: "안녕하세요! 오늘은 누구나 쉽게 따라할 수 있는 영상 편집을 배워볼까요? 정말 간단해요! 차근차근 따라해보세요. 여러분도 멋진 영상을 만들 수 있어요!"
            },
            event: {
                title: "2024 연말 대축제",
                content: "올해를 마무리하는 특별한 축제에 여러분을 초대합니다! 놀라운 공연과 푸짐한 경품이 기다리고 있어요! 12월 31일, 우리 모두 함께 축하해요!"
            }
        };

        // 샘플 로드
        function loadSample(type) {
            const sample = sampleScripts[type];
            if (sample) {
                document.getElementById('scriptTitle').value = sample.title;
                document.getElementById('scriptContent').value = sample.content;
                
                // 스타일 자동 선택
                if (type === 'product') {
                    document.getElementById('videoStyle').value = 'promotional';
                } else if (type === 'tutorial') {
                    document.getElementById('videoStyle').value = 'educational';
                } else if (type === 'event') {
                    document.getElementById('videoStyle').value = 'entertainment';
                }
            }
        }

        // 상태 업데이트
        function updateStatus(step, status, type = 'pending') {
            const statusMap = {
                'script': 'scriptStatus',
                'audio': 'audioGenerationStatus',
                'video': 'videoStatus'
            };
            
            const element = document.getElementById(statusMap[step]);
            if (element) {
                element.textContent = status;
                const indicator = element.parentElement.querySelector('.status-indicator');
                indicator.className = `status-indicator status-${type}`;
            }
        }

        // 스크립트 생성
        async function generateScript() {
            const title = document.getElementById('scriptTitle').value;
            const content = document.getElementById('scriptContent').value;
            const videoStyle = document.getElementById('videoStyle').value;
            const generateAudio = document.getElementById('generateAudio').checked;
            
            if (!title || !content) {
                alert('제목과 내용을 입력해주세요!');
                return;
            }
            
            updateStatus('script', '생성 중...', 'processing');
            document.getElementById('scriptResult').style.display = 'block';
            document.getElementById('scriptResult').innerHTML = '<div class="loading">스크립트를 생성하고 있습니다...</div>';
            
            try {
                const response = await fetch('/api/scripts/generate-video-script', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        baseScript: {
                            id: 'custom_' + Date.now(),
                            title: title,
                            description: '사용자 정의 스크립트',
                            category: videoStyle,
                            tags: [videoStyle],
                            content: {
                                narration: content,
                                scenes: []
                            }
                        },
                        narrationSpeed: 'normal',
                        videoStyle: videoStyle,
                        generateAudio: generateAudio,
                        voiceStyle: 'energetic'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentScript = result.data;
                    
                    document.getElementById('scriptResult').innerHTML = `
                        <div class="success">✅ 스크립트 생성 완료!</div>
                        <p><strong>제목:</strong> ${currentScript.title}</p>
                        <p><strong>길이:</strong> ${currentScript.totalDuration}초</p>
                        <p><strong>장면 수:</strong> ${currentScript.scenes.length}개</p>
                        <details>
                            <summary>상세 정보 보기</summary>
                            <pre>${JSON.stringify(currentScript, null, 2)}</pre>
                        </details>
                    `;
                    
                    updateStatus('script', '완료', 'completed');
                    
                    // 음성이 생성된 경우
                    if (currentScript.audio) {
                        currentAudio = currentScript.audio;
                        showAudio();
                    }
                    
                    // 비디오 생성 버튼 활성화
                    document.getElementById('generateVideoBtn').disabled = false;
                    
                } else {
                    throw new Error(result.error || '스크립트 생성 실패');
                }
                
            } catch (error) {
                console.error('스크립트 생성 오류:', error);
                document.getElementById('scriptResult').innerHTML = `
                    <div class="error">❌ 오류: ${error.message}</div>
                `;
                updateStatus('script', '실패', 'error');
            }
        }

        // 음성 표시
        function showAudio() {
            if (!currentAudio) return;
            
            updateStatus('audio', '완료', 'completed');
            document.getElementById('audioSection').style.display = 'block';
            document.getElementById('audioStatus').style.display = 'none';
            
            document.getElementById('voiceInfo').textContent = 
                `${currentAudio.voiceUsed} (${currentAudio.duration}초)`;
            
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = currentAudio.audioUrl;
            
            // 만족도 변경 시 재생성 버튼 표시
            document.getElementById('audioSatisfaction').onchange = function(e) {
                document.getElementById('regenerateBtn').style.display = 
                    e.target.value === 'regenerate' ? 'block' : 'none';
            };
        }

        // 음성 재생성
        async function regenerateAudio() {
            if (!currentScript) return;
            
            updateStatus('audio', '재생성 중...', 'processing');
            document.getElementById('audioStatus').style.display = 'block';
            document.getElementById('audioStatus').textContent = '새로운 음성을 생성하고 있습니다...';
            
            try {
                // 다른 감정으로 재생성
                const emotions = ['excited', 'motivated', 'enthusiastic', 'cheerful', 'celebratory'];
                const currentEmotion = 'excited'; // 현재 감정
                const newEmotion = emotions[Math.floor(Math.random() * emotions.length)];
                
                const response = await fetch('/api/tts/energetic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: currentScript.narration.fullText,
                        emotion: newEmotion,
                        intensity: 'high',
                        gender: Math.random() > 0.5 ? 'male' : 'female'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentAudio = result.data;
                    showAudio();
                    document.getElementById('audioStatus').innerHTML = 
                        '<div class="success">✅ 새로운 음성이 생성되었습니다!</div>';
                } else {
                    throw new Error(result.error || '음성 재생성 실패');
                }
                
            } catch (error) {
                console.error('음성 재생성 오류:', error);
                document.getElementById('audioStatus').innerHTML = 
                    `<div class="error">❌ 오류: ${error.message}</div>`;
            }
        }

        // 비디오 생성
        async function generateVideo() {
            if (!currentScript) {
                alert('먼저 스크립트를 생성해주세요!');
                return;
            }
            
            updateStatus('video', '생성 중...', 'processing');
            document.getElementById('videoProgress').style.display = 'block';
            
            // 테스트 이미지 경로
            const imageMap = {
                'nature': ['/test-images/nature1.jpg', '/test-images/nature2.jpg', '/test-images/nature3.jpg', '/test-images/nature4.jpg', '/test-images/nature5.jpg'],
                'tech': ['/test-images/tech1.jpg', '/test-images/tech2.jpg', '/test-images/tech3.jpg', '/test-images/tech4.jpg', '/test-images/tech5.jpg'],
                'food': ['/test-images/food1.jpg', '/test-images/food2.jpg', '/test-images/food3.jpg', '/test-images/food4.jpg', '/test-images/food5.jpg'],
                'abstract': ['/test-images/abstract1.jpg', '/test-images/abstract2.jpg', '/test-images/abstract3.jpg', '/test-images/abstract4.jpg', '/test-images/abstract5.jpg']
            };
            
            const selectedImages = document.getElementById('testImages').value;
            const quality = document.getElementById('videoQuality').value;
            const images = imageMap[selectedImages] || imageMap['nature'];
            
            // 진행률 시뮬레이션
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                document.getElementById('progressFill').style.width = progress + '%';
            }, 500);
            
            try {
                const response = await fetch('/api/videos/render', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        images: images,
                        audioUrl: currentAudio?.audioUrl,
                        videoScript: currentScript,
                        outputFormat: 'mp4',
                        quality: quality,
                        resolution: quality === 'high' ? '1080x1920' : quality === 'medium' ? '720x1280' : '540x960',
                        frameRate: 30,
                        projectTitle: currentScript.title
                    })
                });
                
                clearInterval(progressInterval);
                document.getElementById('progressFill').style.width = '100%';
                
                const result = await response.json();
                
                if (result.success) {
                    currentVideo = result.data;
                    
                    document.getElementById('videoResult').style.display = 'block';
                    document.getElementById('videoPlayer').src = currentVideo.videoUrl;
                    document.getElementById('videoInfo').innerHTML = `
                        <div class="success">✅ 비디오 생성 완료!</div>
                        <p><strong>해상도:</strong> ${currentVideo.resolution}</p>
                        <p><strong>길이:</strong> ${currentVideo.duration}초</p>
                        <p><strong>크기:</strong> ${Math.round(currentVideo.fileSize / 1024 / 1024)}MB</p>
                    `;
                    
                    updateStatus('video', '완료', 'completed');
                    showFinalResult();
                    
                } else {
                    throw new Error(result.error || '비디오 생성 실패');
                }
                
            } catch (error) {
                console.error('비디오 생성 오류:', error);
                document.getElementById('videoResult').innerHTML = `
                    <div class="error">❌ 오류: ${error.message}</div>
                `;
                updateStatus('video', '실패', 'error');
            }
            
            clearInterval(progressInterval);
            document.getElementById('videoProgress').style.display = 'none';
        }

        // 최종 결과 표시
        function showFinalResult() {
            document.getElementById('finalResult').style.display = 'block';
            document.getElementById('finalInfo').innerHTML = `
                <div class="success">
                    <h4>🎊 축하합니다! AI Shorts 영상이 완성되었습니다!</h4>
                    <p>제목: ${currentScript.title}</p>
                    <p>음성: ${currentAudio.voiceUsed}</p>
                    <p>비디오: ${currentVideo.resolution} @ ${currentVideo.frameRate}fps</p>
                    <p>총 길이: ${currentVideo.duration}초</p>
                </div>
                <button onclick="downloadVideo()" style="margin-top: 15px;">📥 비디오 다운로드</button>
                <button onclick="resetAll()" style="margin-top: 15px; background: #ff9800;">🔄 새로 만들기</button>
            `;
        }

        // 비디오 다운로드
        function downloadVideo() {
            if (currentVideo && currentVideo.videoUrl) {
                const a = document.createElement('a');
                a.href = currentVideo.videoUrl;
                a.download = currentScript.title + '.mp4';
                a.click();
            }
        }

        // 전체 초기화
        function resetAll() {
            currentScript = null;
            currentAudio = null;
            currentVideo = null;
            
            document.getElementById('scriptResult').style.display = 'none';
            document.getElementById('audioSection').style.display = 'none';
            document.getElementById('videoResult').style.display = 'none';
            document.getElementById('finalResult').style.display = 'none';
            document.getElementById('generateVideoBtn').disabled = true;
            
            updateStatus('script', '대기 중', 'pending');
            updateStatus('audio', '대기 중', 'pending');
            updateStatus('video', '대기 중', 'pending');
            
            // 폼 초기화
            document.getElementById('scriptTitle').value = '';
            document.getElementById('scriptContent').value = '';
        }

        // 서버 상태 확인
        async function checkServer() {
            try {
                const response = await fetch('/api/scripts/generate-video-script', { method: 'GET' });
                console.log('✅ 서버 연결 확인');
            } catch (error) {
                console.error('⚠️ 서버 연결 실패:', error);
                alert('서버가 실행 중이 아닙니다. npm run dev로 서버를 시작하세요.');
            }
        }

        // 페이지 로드 시 서버 확인
        checkServer();
    </script>
</body>
</html>