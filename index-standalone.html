<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1f2937">
    <title>휠복원 AI 쇼츠 제작기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            min-height: 100vh;
        }
        .image-thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            border: 2px solid #4B5563;
            cursor: pointer;
        }
        .image-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-order {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #10B981;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto max-w-md px-4 py-8">
        <!-- 헤더 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">🛞 휠복원 AI 쇼츠 제작기</h1>
            <p class="text-gray-400">휠 작업 사진으로 전문 홍보 쇼츠를 만들어보세요</p>
        </div>

        <!-- API 키 입력 -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <label class="block text-sm font-medium mb-3 text-gray-300">
                🔑 Google Gemini API 키
            </label>
            <input 
                type="password" 
                id="apiKey" 
                placeholder="Gemini API 키를 입력하세요"
                class="w-full px-3 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500"
            >
            <p class="text-xs text-gray-500 mt-2">
                API 키는 브라우저에만 저장되며 서버로 전송되지 않습니다.
            </p>
        </div>

        <!-- 휠 작업 타입 선택 -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <label class="block text-sm font-medium mb-3 text-gray-300">
                🛞 휠 작업 타입 선택
            </label>
            <select id="industrySelect" class="w-full px-3 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500">
                <option value="">휠 작업 타입을 선택하세요</option>
                <option value="wheel-restoration">🛞 휠 복원 (스크래치, 찌그러짐)</option>
                <option value="wheel-repair">🔧 휠 리페어 (균열, 휨 수정)</option>
                <option value="wheel-painting">🎨 휠 도색 (컬러 변경)</option>
                <option value="wheel-custom">✨ 휠 커스터마이징</option>
                <option value="wheel-polishing">💎 휠 폴리싱 (광택)</option>
                <option value="wheel-chrome">🌟 휠 크롬 도금</option>
                <option value="wheel-refinish">🔄 휠 리피니시</option>
                <option value="other">🛠️ 기타 휠 작업</option>
            </select>
        </div>

        <!-- 휠 모델명 입력 -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <label class="block text-sm font-medium mb-3 text-gray-300">
                🏷️ 휠 모델명 또는 작업 설명
            </label>
            <input 
                type="text" 
                id="productName" 
                placeholder="예: BMW 18인치 알로이 휠, 소나타 휠 스크래치 복원"
                class="w-full px-3 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500"
            >
        </div>

        <!-- 이미지 업로드 -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <label class="block text-sm font-medium mb-3 text-gray-300">
                🛞 휠 작업 사진 업로드 (3-10장)
            </label>
            <input 
                type="file" 
                id="imageInput" 
                multiple 
                accept="image/*"
                class="w-full px-3 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            >
            
            <!-- 업로드된 이미지 미리보기 -->
            <div id="imagePreview" class="hidden mt-4">
                <div class="flex flex-wrap gap-2" id="imageContainer"></div>
            </div>
        </div>

        <!-- 분석 시작 버튼 -->
        <button 
            id="startAnalysis" 
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed mb-6"
            disabled
        >
            🚀 AI 분석 시작
        </button>

        <!-- 상태 표시 -->
        <div id="status" class="bg-gray-800 rounded-lg p-4 text-center text-gray-300 hidden">
            준비 중...
        </div>

        <!-- 분석 결과 -->
        <div id="results" class="hidden bg-gray-800 rounded-lg p-4 mt-6">
            <h3 class="text-lg font-bold mb-4">📊 분석 결과</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script type="module">
        let uploadedImages = [];
        let analysisResults = [];

        const apiKeyInput = document.getElementById('apiKey');
        const industrySelect = document.getElementById('industrySelect');
        const productNameInput = document.getElementById('productName');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const imageContainer = document.getElementById('imageContainer');
        const startAnalysisBtn = document.getElementById('startAnalysis');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const resultContent = document.getElementById('resultContent');

        // 파일 업로드 핸들러
        imageInput.addEventListener('change', handleFileUpload);
        
        // 입력 필드 변경 시 버튼 상태 업데이트
        [apiKeyInput, industrySelect, productNameInput].forEach(input => {
            input.addEventListener('change', updateButtonState);
            input.addEventListener('input', updateButtonState);
        });

        // 분석 시작 버튼 클릭
        startAnalysisBtn.addEventListener('click', startAnalysis);

        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            
            if (files.length < 3 || files.length > 10) {
                showStatus('❌ 이미지는 3장 이상 10장 이하로 업로드해주세요.');
                return;
            }

            uploadedImages = [];
            imageContainer.innerHTML = '';

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        name: file.name,
                        dataUrl: e.target.result,
                        file: file
                    };
                    
                    uploadedImages.push(imageData);

                    // 미리보기 생성
                    const thumbDiv = document.createElement('div');
                    thumbDiv.className = 'image-thumb';
                    thumbDiv.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <div class="image-order">${index + 1}</div>
                    `;
                    imageContainer.appendChild(thumbDiv);

                    if (uploadedImages.length === files.length) {
                        imagePreview.classList.remove('hidden');
                        updateButtonState();
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function updateButtonState() {
            const hasApiKey = apiKeyInput.value.trim().length > 0;
            const hasIndustry = industrySelect.value.trim().length > 0;
            const hasProductName = productNameInput.value.trim().length > 0;
            const hasImages = uploadedImages.length >= 3;

            startAnalysisBtn.disabled = !(hasApiKey && hasIndustry && hasProductName && hasImages);
        }

        function showStatus(message) {
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
        }

        async function startAnalysis() {
            try {
                startAnalysisBtn.disabled = true;
                showStatus('🔍 이미지를 분석하는 중...');

                const apiKey = apiKeyInput.value.trim();
                const industry = industrySelect.value;
                const productName = productNameInput.value.trim();

                // 각 이미지 분석
                analysisResults = [];
                
                for (let i = 0; i < uploadedImages.length; i++) {
                    showStatus(`🔍 이미지 ${i + 1}/${uploadedImages.length} 분석 중...`);
                    
                    const imageData = uploadedImages[i];
                    const base64Data = imageData.dataUrl.split(',')[1];
                    
                    const analysis = await analyzeImageWithGemini(apiKey, base64Data, industry, productName);
                    analysisResults.push({
                        image: imageData,
                        analysis: analysis
                    });
                }

                // 전체 스토리 생성
                showStatus('📝 스토리를 생성하는 중...');
                const story = await generateStoryWithGemini(apiKey, analysisResults, industry, productName);

                // 결과 표시
                displayResults(story);
                showStatus('✅ 분석이 완료되었습니다!');

            } catch (error) {
                console.error('분석 오류:', error);
                showStatus(`❌ 오류가 발생했습니다: ${error.message}`);
                startAnalysisBtn.disabled = false;
            }
        }

        async function analyzeImageWithGemini(apiKey, base64Image, industry, productName) {
            const prompt = `휠복원 전문가의 관점에서 이 이미지를 분석해주세요.

작업 타입: ${industry}
제품명: ${productName}

다음 항목들을 분석해주세요:
1. 휠의 상태 (손상 정도, 타입 등)
2. 작업 단계 (작업 전/중/후)
3. 주요 특징 및 변화
4. 전문적인 관찰 내용

JSON 형식으로 응답해주세요:
{
  "condition": "휠 상태 설명",
  "stage": "작업 단계",
  "features": "주요 특징",
  "professional_notes": "전문가 의견"
}`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: base64Image
                                }
                            }
                        ]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API 오류: ${response.status}`);
            }

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            
            try {
                return JSON.parse(text);
            } catch {
                return { analysis: text };
            }
        }

        async function generateStoryWithGemini(apiKey, analysisResults, industry, productName) {
            const analysisText = analysisResults.map((result, index) => 
                `이미지 ${index + 1}: ${JSON.stringify(result.analysis)}`
            ).join('\n\n');

            const prompt = `휠복원 전문업체의 SNS 홍보용 쇼츠 영상 스크립트를 작성해주세요.

작업 타입: ${industry}
제품명: ${productName}

이미지 분석 결과:
${analysisText}

30초 분량의 매력적인 스토리를 만들어주세요:
1. 임팩트 있는 시작
2. 작업 과정의 전문성 강조
3. 결과의 만족감
4. 행동 유도 마무리

각 이미지별로 5-7초씩 할당하여 스크립트를 작성해주세요.`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API 오류: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function displayResults(story) {
            resultContent.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-bold text-green-400 mb-2">📝 생성된 스토리</h4>
                        <pre class="whitespace-pre-wrap text-sm">${story}</pre>
                    </div>
                    
                    <div class="bg-gray-700 rounded p-4">
                        <h4 class="font-bold text-blue-400 mb-2">🔍 이미지별 분석</h4>
                        ${analysisResults.map((result, index) => `
                            <div class="mb-3 p-3 bg-gray-600 rounded">
                                <div class="font-semibold">이미지 ${index + 1}: ${result.image.name}</div>
                                <div class="text-sm mt-1">${JSON.stringify(result.analysis, null, 2)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            resultsDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>