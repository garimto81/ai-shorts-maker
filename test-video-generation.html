<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ë””ì˜¤ ìƒì„± ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 8px; 
            background: rgba(255,255,255,0.05);
        }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover { 
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .result { 
            margin-top: 15px; 
            padding: 15px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 8px; 
            max-height: 400px;
            overflow-y: auto;
        }
        .success { 
            background: rgba(76, 175, 80, 0.2); 
            color: #a5d6a7; 
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        .error { 
            background: rgba(244, 67, 54, 0.2); 
            color: #ef9a9a; 
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        .loading {
            background: rgba(255, 193, 7, 0.2);
            color: #fff3c4;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .api-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .api-ok { background: rgba(76, 175, 80, 0.3); color: #a5d6a7; }
        .api-error { background: rgba(244, 67, 54, 0.3); color: #ef9a9a; }
        .test-data {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ AI ì‡¼ì¸  ë©”ì´ì»¤ v2.3.0 í…ŒìŠ¤íŠ¸</h1>
        <p>í–¥ìƒëœ ì˜ìƒ ìƒì„± ì‹œìŠ¤í…œì˜ ëª¨ë“  ë‹¨ê³„ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
        
        <!-- API ìƒíƒœ ì²´í¬ -->
        <div class="test-section">
            <h3>1. API ì„œë²„ ìƒíƒœ ì²´í¬</h3>
            <button onclick="checkAPIStatus()">ğŸ” API ìƒíƒœ í™•ì¸</button>
            <div id="apiResult" class="result"></div>
        </div>

        <!-- íŒŒì¼ëª… ì •ë ¬ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>2. AI íŒŒì¼ëª… ë¶„ì„ ë° ì •ë ¬</h3>
            <div class="test-data">
                í…ŒìŠ¤íŠ¸ íŒŒì¼ëª…: ["damaged_wheel_01.jpg", "process_step2.jpg", "final_result.jpg", "before_damage.jpg"]
            </div>
            <button onclick="testFilenameSort()">ğŸ“‹ íŒŒì¼ëª… ì •ë ¬ í…ŒìŠ¤íŠ¸</button>
            <div id="sortResult" class="result"></div>
        </div>

        <!-- ì´ë¯¸ì§€ ë¶„ì„ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>3. ë°°ì¹˜ ì´ë¯¸ì§€ ë¶„ì„</h3>
            <p>ì‹¤ì œ ì´ë¯¸ì§€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë¶„ì„ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</p>
            <input type="file" id="testImages" multiple accept="image/*" style="margin-bottom: 10px;">
            <br>
            <button onclick="testBatchAnalysis()">ğŸ” ë°°ì¹˜ ë¶„ì„ í…ŒìŠ¤íŠ¸</button>
            <div id="analysisResult" class="result"></div>
        </div>

        <!-- ë‚˜ë ˆì´ì…˜ ìƒì„± í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>4. 2ë‹¨ê³„ ë‚˜ë ˆì´ì…˜ ìƒì„±</h3>
            <button onclick="testNarrationGeneration()" id="narrationBtn">ğŸ™ï¸ ë‚˜ë ˆì´ì…˜ ìƒì„± í…ŒìŠ¤íŠ¸</button>
            <div id="narrationResult" class="result"></div>
        </div>

        <!-- í†µí•© ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>5. ì „ì²´ 3ë‹¨ê³„ ì›Œí¬í”Œë¡œìš°</h3>
            <button onclick="testCompleteWorkflow()" id="workflowBtn">ğŸš€ ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸</button>
            <div id="workflowResult" class="result"></div>
        </div>

        <!-- ë¹„ë””ì˜¤ ìƒì„± í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>6. í–¥ìƒëœ ë¹„ë””ì˜¤ ìƒì„±</h3>
            <button onclick="testVideoGeneration()" id="videoBtn" disabled>ğŸ¬ ë¹„ë””ì˜¤ ìƒì„± í…ŒìŠ¤íŠ¸</button>
            <div id="videoResult" class="result"></div>
        </div>
    </div>

    <script>
        let analysisResults = null;
        let finalStoryData = null;
        let testImages = [];

        // API ìƒíƒœ í™•ì¸
        async function checkAPIStatus() {
            const result = document.getElementById('apiResult');
            result.className = 'result loading';
            result.innerHTML = 'ğŸ”„ API ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘...';

            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                result.className = 'result success';
                result.innerHTML = `
                    <strong>âœ… API ì„œë²„ ì •ìƒ ë™ì‘</strong><br>
                    <span class="api-status api-ok">ìƒíƒœ: ${data.status}</span><br>
                    <span class="api-status ${data.geminiApiKey ? 'api-ok' : 'api-error'}">
                        Gemini API: ${data.geminiApiKey ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •'}
                    </span><br>
                    <span>íƒ€ì„ìŠ¤íƒ¬í”„: ${data.timestamp}</span>
                `;
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ API ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
            }
        }

        // íŒŒì¼ëª… ì •ë ¬ í…ŒìŠ¤íŠ¸
        async function testFilenameSort() {
            const result = document.getElementById('sortResult');
            result.className = 'result loading';
            result.textContent = 'ğŸ”„ AI íŒŒì¼ëª… ë¶„ì„ ì¤‘...';

            try {
                const testFilenames = ["damaged_wheel_01.jpg", "process_step2.jpg", "final_result.jpg", "before_damage.jpg"];
                
                const formData = new FormData();
                formData.append('filenames', JSON.stringify(testFilenames));
                formData.append('industry', 'wheel');

                const response = await fetch('/api/sort-filenames', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    result.className = 'result success';
                    result.innerHTML = `
                        <strong>âœ… íŒŒì¼ëª… ì •ë ¬ ì„±ê³µ!</strong><br>
                        <strong>ì›ë³¸ ìˆœì„œ:</strong> ${testFilenames.join(', ')}<br>
                        <strong>AI ì •ë ¬ ìˆœì„œ:</strong> ${data.data.sortedOrder.map(i => testFilenames[i]).join(', ')}<br>
                        <strong>ë¶„ì„ ê²°ê³¼:</strong> ${data.data.analysis}<br>
                        <strong>ì •ë ¬ ì´ìœ :</strong> ${data.data.reasoning}
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ íŒŒì¼ëª… ì •ë ¬ ì‹¤íŒ¨: ${error.message}`;
            }
        }

        // ë°°ì¹˜ ì´ë¯¸ì§€ ë¶„ì„ í…ŒìŠ¤íŠ¸
        async function testBatchAnalysis() {
            const result = document.getElementById('analysisResult');
            const fileInput = document.getElementById('testImages');
            
            if (!fileInput.files || fileInput.files.length < 3) {
                result.className = 'result error';
                result.textContent = 'âŒ ìµœì†Œ 3ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                return;
            }

            result.className = 'result loading';
            result.innerHTML = `ğŸ”„ ${fileInput.files.length}ì¥ ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...`;

            try {
                const formData = new FormData();
                
                for (let i = 0; i < fileInput.files.length; i++) {
                    formData.append('images', fileInput.files[i]);
                    testImages.push(fileInput.files[i]);
                }
                formData.append('sortMethod', 'ai');

                const response = await fetch('/api/analyze-batch', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    analysisResults = data.results;
                    result.className = 'result success';
                    result.innerHTML = `
                        <strong>âœ… ë°°ì¹˜ ë¶„ì„ ì„±ê³µ!</strong><br>
                        <strong>ì´ ì´ë¯¸ì§€:</strong> ${data.totalImages}ì¥<br>
                        <strong>ì„±ê³µ:</strong> ${data.results.filter(r => r.success).length}ì¥<br>
                        <strong>ì‹¤íŒ¨:</strong> ${data.results.filter(r => !r.success).length}ì¥<br>
                        <strong>ì •ë ¬ ë°©ì‹:</strong> ${data.sortMethod}<br><br>
                        <strong>ë¶„ì„ ê²°ê³¼:</strong><br>
                        ${data.results.map((r, i) => `${i+1}. ${r.filename}: ${r.success ? 'âœ…' : 'âŒ'} ${r.analysis || r.error}`).join('<br>')}
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ ë°°ì¹˜ ë¶„ì„ ì‹¤íŒ¨: ${error.message}`;
            }
        }

        // ë‚˜ë ˆì´ì…˜ ìƒì„± í…ŒìŠ¤íŠ¸
        async function testNarrationGeneration() {
            const result = document.getElementById('narrationResult');
            const btn = document.getElementById('narrationBtn');
            
            if (!analysisResults || analysisResults.length === 0) {
                result.className = 'result error';
                result.textContent = 'âŒ ë¨¼ì € ì´ë¯¸ì§€ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.';
                return;
            }

            btn.disabled = true;
            result.className = 'result loading';
            result.textContent = 'ğŸ”„ 2ë‹¨ê³„ ë‚˜ë ˆì´ì…˜ ìƒì„± ì¤‘...';

            try {
                const response = await fetch('/api/generate-narration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysisResults: analysisResults,
                        industry: 'wheel'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    finalStoryData = data.data;
                    document.getElementById('videoBtn').disabled = false;
                    
                    result.className = 'result success';
                    result.innerHTML = `
                        <strong>âœ… 2ë‹¨ê³„ ë‚˜ë ˆì´ì…˜ ìƒì„± ì„±ê³µ!</strong><br>
                        <strong>ì „ì²´ ê¸¸ì´:</strong> ${data.data.totalDuration}ì´ˆ<br>
                        <strong>ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜:</strong> ${data.data.segments ? data.data.segments.length : 0}ê°œ<br>
                        <strong>ìŠ¤í† ë¦¬ ì œëª©:</strong> ${data.data.fullStoryData ? data.data.fullStoryData.title || 'ì œëª© ì—†ìŒ' : 'ì „ì²´ ìŠ¤í† ë¦¬ ì—†ìŒ'}<br>
                        <strong>í‚¤ì›Œë“œ:</strong> ${data.data.keywords ? data.data.keywords.join(', ') : 'ì—†ìŒ'}<br><br>
                        <strong>ì „ì²´ ìŠ¤í† ë¦¬:</strong><br>
                        <pre style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px;">
${data.data.fullStoryData ? data.data.fullStoryData.fullScript || 'ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ' : 'ì „ì²´ ìŠ¤í† ë¦¬ ì—†ìŒ'}
                        </pre><br>
                        <strong>ì„¸ê·¸ë¨¼íŠ¸ë³„ ë‚˜ë ˆì´ì…˜:</strong><br>
                        ${data.data.segments ? data.data.segments.map((s, i) => `${i+1}. ${s.narration || 'ë‚˜ë ˆì´ì…˜ ì—†ìŒ'}`).join('<br>') : 'ì„¸ê·¸ë¨¼íŠ¸ ì—†ìŒ'}
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ ë‚˜ë ˆì´ì…˜ ìƒì„± ì‹¤íŒ¨: ${error.message}`;
            } finally {
                btn.disabled = false;
            }
        }

        // ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸
        async function testCompleteWorkflow() {
            const result = document.getElementById('workflowResult');
            const btn = document.getElementById('workflowBtn');
            const fileInput = document.getElementById('testImages');
            
            if (!fileInput.files || fileInput.files.length < 3) {
                result.className = 'result error';
                result.textContent = 'âŒ ìµœì†Œ 3ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                return;
            }

            btn.disabled = true;
            result.className = 'result loading';
            result.innerHTML = 'ğŸ”„ ì „ì²´ 3ë‹¨ê³„ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘...';

            try {
                const formData = new FormData();
                
                for (let i = 0; i < fileInput.files.length; i++) {
                    formData.append('images', fileInput.files[i]);
                }
                formData.append('sortMethod', 'ai');
                formData.append('industry', 'wheel');

                const response = await fetch('/api/complete-workflow', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    analysisResults = data.analysis.results;
                    finalStoryData = data.narration;
                    document.getElementById('videoBtn').disabled = false;
                    
                    result.className = 'result success';
                    result.innerHTML = `
                        <strong>âœ… ì „ì²´ ì›Œí¬í”Œë¡œìš° ì„±ê³µ!</strong><br>
                        <strong>ì²˜ë¦¬ ì‹œê°„:</strong> ${data.workflow.processingTime}ì´ˆ<br>
                        <strong>ì´ ì´ë¯¸ì§€:</strong> ${data.workflow.totalImages}ì¥<br>
                        <strong>ì •ë ¬ ë°©ì‹:</strong> ${data.workflow.sortMethod}<br>
                        <strong>ì—…ì¢…:</strong> ${data.workflow.industry}<br><br>
                        <strong>ë¶„ì„ ê²°ê³¼:</strong> ì„±ê³µ ${data.analysis.successCount}ì¥ / ì‹¤íŒ¨ ${data.analysis.failCount}ì¥<br>
                        <strong>ë‚˜ë ˆì´ì…˜:</strong> ${data.narration.segments ? data.narration.segments.length : 0}ê°œ ì„¸ê·¸ë¨¼íŠ¸ ìƒì„±<br>
                        <strong>ì „ì²´ ìŠ¤í† ë¦¬ ì œëª©:</strong> ${data.narration.fullStoryData ? data.narration.fullStoryData.title || 'ì œëª© ì—†ìŒ' : 'ì—†ìŒ'}
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨: ${error.message}`;
            } finally {
                btn.disabled = false;
            }
        }

        // ë¹„ë””ì˜¤ ìƒì„± í…ŒìŠ¤íŠ¸
        async function testVideoGeneration() {
            const result = document.getElementById('videoResult');
            const btn = document.getElementById('videoBtn');
            const fileInput = document.getElementById('testImages');
            
            if (!finalStoryData || !analysisResults) {
                result.className = 'result error';
                result.textContent = 'âŒ ë¨¼ì € ì „ì²´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.';
                return;
            }

            btn.disabled = true;
            result.className = 'result loading';
            result.innerHTML = 'ğŸ”„ í–¥ìƒëœ ë¹„ë””ì˜¤ ìƒì„± ì¤‘... (2-3ë¶„ ì†Œìš”)';

            try {
                const formData = new FormData();
                
                for (let i = 0; i < fileInput.files.length; i++) {
                    formData.append('images', fileInput.files[i]);
                }
                
                formData.append('productName', 'í…ŒìŠ¤íŠ¸ ì œí’ˆ');
                formData.append('industry', 'wheel');
                formData.append('style', 'dynamic');
                formData.append('duration', '30');
                formData.append('analysisResults', JSON.stringify(analysisResults));
                formData.append('finalStory', JSON.stringify(finalStoryData));

                const response = await fetch('/api/generate-video', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    result.className = 'result success';
                    result.innerHTML = `
                        <strong>âœ… ë¹„ë””ì˜¤ ìƒì„± ì„±ê³µ!</strong><br>
                        <strong>íŒŒì¼ëª…:</strong> ${data.filename}<br>
                        <strong>ì˜ìƒ ê¸¸ì´:</strong> ${data.duration}ì´ˆ<br>
                        <strong>ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜:</strong> ${data.metadata.segmentCount}ê°œ<br>
                        <strong>ì´ë¯¸ì§€ ìˆ˜:</strong> ${data.metadata.totalImages}ê°œ<br>
                        <strong>ì²˜ë¦¬ ì‹œê°„:</strong> ${Math.round(data.metadata.processingTime/1000)}ì´ˆ<br>
                        <strong>ìŠ¤í† ë¦¬ ì œëª©:</strong> ${data.metadata.storyTitle || 'ì—†ìŒ'}<br><br>
                        <a href="/output/${data.filename}" download="${data.filename}" 
                           style="display: inline-block; padding: 10px 20px; background: linear-gradient(45deg, #4caf50, #45a049); color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
                           ğŸ“¥ ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
                        </a>
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ ë¹„ë””ì˜¤ ìƒì„± ì‹¤íŒ¨: ${error.message}`;
            } finally {
                btn.disabled = false;
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ API ìƒíƒœ ìë™ í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            checkAPIStatus();
        });
    </script>
</body>
</html>