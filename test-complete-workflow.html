<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎬 AI 쇼츠 제작 통합 워크플로우</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        }
        
        .workflow-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .drop-zone {
            border: 3px dashed #64748b;
            transition: all 0.3s ease;
            min-height: 200px;
        }
        
        .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }
        
        .step-indicator {
            position: relative;
            padding-left: 2rem;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background: #64748b;
        }
        
        .step-indicator.active::before {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            animation: pulse 2s infinite;
        }
        
        .step-indicator.completed::before {
            background: #10b981;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: translateY(-50%) scale(1); }
            50% { opacity: 0.8; transform: translateY(-50%) scale(1.1); }
        }
        
        .industry-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .industry-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }
        
        .industry-card.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .narration-segment {
            background: rgba(0, 0, 0, 0.2);
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }
        
        .narration-segment:hover {
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="min-h-screen text-white">
    <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-600 bg-clip-text text-transparent mb-4">
                🎬 AI 쇼츠 제작 공장
            </h1>
            <p class="text-xl text-slate-300">이미지 분석 → AI 정렬 → 나레이션 생성을 한 번에!</p>
        </div>

        <!-- 진행 단계 표시 -->
        <div class="workflow-card rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6">📋 워크플로우 진행 상황</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="step-indicator" id="step1">
                    <div class="text-lg font-semibold">1. 이미지 업로드</div>
                    <div class="text-sm text-slate-400">5-10장 제품 이미지</div>
                </div>
                <div class="step-indicator" id="step2">
                    <div class="text-lg font-semibold">2. AI 파일명 정렬</div>
                    <div class="text-sm text-slate-400">최적 순서 자동 결정</div>
                </div>
                <div class="step-indicator" id="step3">
                    <div class="text-lg font-semibold">3. 이미지 분석</div>
                    <div class="text-sm text-slate-400">전문적 상품 설명 생성</div>
                </div>
                <div class="step-indicator" id="step4">
                    <div class="text-lg font-semibold">4. 나레이션 제작</div>
                    <div class="text-sm text-slate-400">이미지당 5초씩 배정</div>
                </div>
            </div>
        </div>

        <!-- 파일 업로드 -->
        <div class="workflow-card rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6">📁 제품 이미지 업로드</h2>
            
            <div class="drop-zone rounded-xl p-8 text-center cursor-pointer" id="dropZone">
                <div class="text-4xl mb-4">🎯</div>
                <div class="text-xl font-semibold mb-2">이미지를 드래그하거나 클릭하여 선택</div>
                <div class="text-slate-400">5-10장의 제품 이미지를 업로드하세요</div>
                <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
            </div>

            <!-- 선택된 파일 표시 -->
            <div id="selectedFiles" class="mt-6 hidden">
                <h3 class="text-lg font-semibold mb-4">선택된 파일 (<span id="fileCount">0</span>장)</h3>
                <div id="fileList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
            </div>
        </div>

        <!-- 업종 선택 -->
        <div class="workflow-card rounded-2xl p-8 mb-8" id="industrySection" style="display: none;">
            <h2 class="text-2xl font-bold mb-6">🏭 업종 선택</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="industry-card workflow-card rounded-xl p-6 border border-slate-600" data-industry="auto">
                    <div class="text-2xl mb-3">🚗</div>
                    <div class="text-lg font-semibold">중고차 매매</div>
                    <div class="text-sm text-slate-400 mt-2">자동차, 차량 부품, 용품</div>
                </div>
                
                <div class="industry-card workflow-card rounded-xl p-6 border border-slate-600" data-industry="wheel-restoration">
                    <div class="text-2xl mb-3">🛞</div>
                    <div class="text-lg font-semibold">자동차 휠 복원</div>
                    <div class="text-sm text-slate-400 mt-2">휠 리페어, 휠 재생, 알로이 휠, 스크래치 제거, 찌그러짐 복원</div>
                </div>
                
                <div class="industry-card workflow-card rounded-xl p-6 border border-slate-600" data-industry="fashion">
                    <div class="text-2xl mb-3">👗</div>
                    <div class="text-lg font-semibold">패션/의류</div>
                    <div class="text-sm text-slate-400 mt-2">의류, 신발, 액세서리</div>
                </div>
                
                <div class="industry-card workflow-card rounded-xl p-6 border border-slate-600" data-industry="electronics">
                    <div class="text-2xl mb-3">📱</div>
                    <div class="text-lg font-semibold">전자제품</div>
                    <div class="text-sm text-slate-400 mt-2">스마트폰, 노트북, IT기기</div>
                </div>
                
                <div class="industry-card workflow-card rounded-xl p-6 border border-slate-600" data-industry="furniture">
                    <div class="text-2xl mb-3">🪑</div>
                    <div class="text-lg font-semibold">가구/생활용품</div>
                    <div class="text-sm text-slate-400 mt-2">가구, 인테리어, 생활용품</div>
                </div>
                
                <div class="industry-card workflow-card rounded-xl p-6 border border-slate-600" data-industry="general">
                    <div class="text-2xl mb-3">📦</div>
                    <div class="text-lg font-semibold">일반 상품</div>
                    <div class="text-sm text-slate-400 mt-2">기타 모든 상품</div>
                </div>
            </div>
        </div>

        <!-- 시작 버튼 -->
        <div class="text-center mb-8" id="startSection" style="display: none;">
            <button id="startWorkflowBtn" 
                    class="px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl font-semibold text-lg hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105">
                🚀 AI 쇼츠 제작 시작
            </button>
        </div>

        <!-- 진행 상황 -->
        <div id="progressSection" class="workflow-card rounded-2xl p-8 mb-8" style="display: none;">
            <h2 class="text-2xl font-bold mb-6">⚡ 처리 진행 상황</h2>
            
            <div class="flex items-center justify-between mb-4">
                <div class="text-lg" id="currentTask">처리 시작...</div>
                <div class="text-lg font-semibold" id="progressText">0%</div>
            </div>
            
            <div class="w-full bg-slate-700 rounded-full h-3 mb-6">
                <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            
            <!-- 상세 진행 상황 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div>
                    <div class="text-sm text-slate-400">경과 시간</div>
                    <div class="text-xl font-bold text-blue-400" id="elapsedTime">0초</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400">현재 단계</div>
                    <div class="text-xl font-bold text-green-400" id="currentStage">준비</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400">처리된 이미지</div>
                    <div class="text-xl font-bold text-purple-400" id="processedImages">0</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400">예상 나레이션</div>
                    <div class="text-xl font-bold text-yellow-400" id="estimatedDuration">0초</div>
                </div>
            </div>
        </div>

        <!-- 최종 결과 -->
        <div id="resultSection" class="workflow-card rounded-2xl p-8" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">🎉 쇼츠 제작 완료!</h2>
                <div class="flex gap-3">
                    <button id="downloadScript" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700 transition-colors">
                        📝 나레이션 다운로드
                    </button>
                    <button id="exportData" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                        📊 전체 데이터 내보내기
                    </button>
                </div>
            </div>
            
            <!-- 워크플로우 요약 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="p-4 bg-slate-800 rounded-xl text-center">
                    <div class="text-sm text-slate-400">총 이미지</div>
                    <div class="text-2xl font-bold text-blue-400" id="totalImages">0장</div>
                </div>
                <div class="p-4 bg-slate-800 rounded-xl text-center">
                    <div class="text-sm text-slate-400">나레이션 길이</div>
                    <div class="text-2xl font-bold text-green-400" id="narrationLength">0초</div>
                </div>
                <div class="p-4 bg-slate-800 rounded-xl text-center">
                    <div class="text-sm text-slate-400">처리 시간</div>
                    <div class="text-2xl font-bold text-purple-400" id="processingTime">0초</div>
                </div>
                <div class="p-4 bg-slate-800 rounded-xl text-center">
                    <div class="text-sm text-slate-400">성공률</div>
                    <div class="text-2xl font-bold text-yellow-400" id="successRate">100%</div>
                </div>
            </div>

            <!-- 이미지 분석 결과 -->
            <div class="mb-8">
                <h3 class="text-xl font-bold mb-4">📸 이미지 분석 결과</h3>
                <div id="analysisResults" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>

            <!-- 나레이션 스크립트 -->
            <div class="mb-8">
                <h3 class="text-xl font-bold mb-4">🎙️ 생성된 나레이션 스크립트</h3>
                <div class="bg-slate-800 rounded-xl p-6">
                    <div id="fullScript" class="text-slate-300 leading-relaxed whitespace-pre-wrap"></div>
                </div>
            </div>

            <!-- 세그먼트별 나레이션 -->
            <div>
                <h3 class="text-xl font-bold mb-4">⏱️ 시간별 나레이션 구성</h3>
                <div id="narrationSegments" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let selectedIndustry = 'auto';
        let workflowData = {};
        let startTime = 0;

        // DOM 요소들
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const selectedFilesDiv = document.getElementById('selectedFiles');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const industrySection = document.getElementById('industrySection');
        const startSection = document.getElementById('startSection');
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');

        // 파일 업로드 처리
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFileSelection(files);
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFileSelection(files);
        });

        // 파일 선택 처리
        function handleFileSelection(files) {
            if (files.length > 10) {
                alert('최대 10장의 이미지만 선택할 수 있습니다.');
                return;
            }

            if (files.length < 5) {
                alert('최소 5장의 이미지가 필요합니다.');
                return;
            }

            selectedFiles = files.slice(0, 10);
            displaySelectedFiles();
            updateStepIndicator(1);
            
            industrySection.style.display = 'block';
            updateEstimatedDuration();
        }

        // 선택된 파일 표시
        function displaySelectedFiles() {
            if (selectedFiles.length === 0) {
                selectedFilesDiv.classList.add('hidden');
                return;
            }

            selectedFilesDiv.classList.remove('hidden');
            fileCount.textContent = selectedFiles.length;

            fileList.innerHTML = selectedFiles.map((file, index) => `
                <div class="flex items-center justify-between p-3 bg-slate-800 rounded-lg">
                    <div class="flex items-center">
                        <span class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-sm font-bold mr-3">
                            ${index + 1}
                        </span>
                        <span class="text-sm">${file.name}</span>
                    </div>
                    <div class="text-sm text-slate-400">
                        ${(file.size / 1024 / 1024).toFixed(2)} MB
                    </div>
                </div>
            `).join('');
        }

        // 업종 선택 처리
        document.querySelectorAll('.industry-card').forEach(card => {
            card.addEventListener('click', () => {
                // 이전 선택 제거
                document.querySelectorAll('.industry-card').forEach(c => c.classList.remove('selected'));
                
                // 새 선택 활성화
                card.classList.add('selected');
                selectedIndustry = card.dataset.industry;
                
                startSection.style.display = 'block';
                updateEstimatedDuration();
            });
        });

        // 예상 나레이션 시간 업데이트
        function updateEstimatedDuration() {
            if (selectedFiles.length > 0) {
                const duration = selectedFiles.length * 5;
                document.getElementById('estimatedDuration').textContent = `${duration}초`;
            }
        }

        // 단계 표시기 업데이트
        function updateStepIndicator(step) {
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                stepElement.classList.remove('active', 'completed');
                
                if (i < step) {
                    stepElement.classList.add('completed');
                } else if (i === step) {
                    stepElement.classList.add('active');
                }
            }
        }

        // 워크플로우 시작
        document.getElementById('startWorkflowBtn').addEventListener('click', () => {
            if (selectedFiles.length < 5) {
                alert('최소 5장의 이미지가 필요합니다.');
                return;
            }

            if (!selectedIndustry) {
                alert('업종을 선택해주세요.');
                return;
            }

            startWorkflow();
        });

        // 워크플로우 실행
        async function startWorkflow() {
            startTime = Date.now();
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
            
            try {
                // 진행 상황 업데이트
                updateProgress(0, '워크플로우 시작...', '준비');
                updateStepIndicator(2);
                
                // FormData 생성
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('images', file);
                });
                formData.append('sortMethod', 'ai');
                formData.append('industry', selectedIndustry);
                
                updateProgress(25, 'AI가 파일명을 분석하는 중...', '파일명 정렬');
                
                // 통합 워크플로우 API 호출
                const response = await fetch('/api/complete-workflow', {
                    method: 'POST',
                    body: formData
                });
                
                updateProgress(50, '이미지를 분석하는 중...', '이미지 분석');
                updateStepIndicator(3);
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || '워크플로우 실패');
                }
                
                updateProgress(75, '나레이션을 생성하는 중...', '나레이션 제작');
                updateStepIndicator(4);
                
                workflowData = result;
                
                updateProgress(100, '워크플로우 완료!', '완료');
                
                // 결과 표시
                displayResults();
                
            } catch (error) {
                console.error('워크플로우 오류:', error);
                updateProgress(0, `오류 발생: ${error.message}`, '실패');
            }
        }

        // 진행 상황 업데이트
        function updateProgress(percentage, task, stage) {
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('currentTask').textContent = task;
            document.getElementById('progressText').textContent = `${percentage}%`;
            document.getElementById('currentStage').textContent = stage;
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('elapsedTime').textContent = `${elapsed}초`;
            
            if (workflowData.analysis && workflowData.analysis.results) {
                document.getElementById('processedImages').textContent = workflowData.analysis.results.length;
            }
        }

        // 결과 표시
        function displayResults() {
            const { workflow, analysis, narration } = workflowData;
            
            // 요약 통계
            document.getElementById('totalImages').textContent = `${workflow.totalImages}장`;
            document.getElementById('narrationLength').textContent = `${narration.totalDuration}초`;
            document.getElementById('processingTime').textContent = `${workflow.processingTime}초`;
            
            const successRate = analysis.results.length > 0 
                ? (analysis.successCount / analysis.results.length * 100).toFixed(1)
                : 0;
            document.getElementById('successRate').textContent = `${successRate}%`;
            
            // 이미지 분석 결과
            const analysisResultsDiv = document.getElementById('analysisResults');
            analysisResultsDiv.innerHTML = analysis.results.map((result, index) => `
                <div class="workflow-card rounded-xl p-4">
                    <div class="font-semibold text-lg mb-2">${result.filename}</div>
                    ${result.success ? `
                        <div class="text-green-400 mb-2">✅ 분석 성공</div>
                        <div class="text-slate-300 text-sm leading-relaxed">
                            ${result.analysis}
                        </div>
                    ` : `
                        <div class="text-red-400 mb-2">❌ 분석 실패</div>
                        <div class="text-slate-400 text-sm">
                            ${result.error}
                        </div>
                    `}
                </div>
            `).join('');
            
            // 나레이션 스크립트
            document.getElementById('fullScript').textContent = narration.fullScript;
            
            // 세그먼트별 나레이션
            const segmentsDiv = document.getElementById('narrationSegments');
            segmentsDiv.innerHTML = narration.segments.map((segment, index) => `
                <div class="narration-segment rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-semibold">
                            이미지 ${segment.imageIndex + 1} (${segment.startTime}초 - ${segment.endTime}초)
                        </div>
                        <div class="text-sm text-blue-400">5초</div>
                    </div>
                    <div class="text-slate-300 text-sm leading-relaxed">
                        ${segment.script}
                    </div>
                </div>
            `).join('');
            
            resultSection.style.display = 'block';
        }

        // 나레이션 스크립트 다운로드
        document.getElementById('downloadScript').addEventListener('click', () => {
            if (!workflowData.narration) return;
            
            const script = `
AI 쇼츠 나레이션 스크립트
========================

업종: ${selectedIndustry}
총 이미지: ${workflowData.workflow.totalImages}장
나레이션 길이: ${workflowData.narration.totalDuration}초
생성일: ${new Date().toLocaleString()}

전체 스크립트:
${workflowData.narration.fullScript}

시간별 구성:
${workflowData.narration.segments.map(seg => 
    `[${seg.startTime}s-${seg.endTime}s] ${seg.script}`
).join('\n')}

핵심 키워드:
${workflowData.narration.keywords.join(', ')}
            `;
            
            downloadFile(`narration-script-${new Date().toISOString().slice(0, 19)}.txt`, script, 'text/plain');
        });

        // 전체 데이터 내보내기
        document.getElementById('exportData').addEventListener('click', () => {
            if (!workflowData) return;
            
            const exportData = {
                ...workflowData,
                exportInfo: {
                    timestamp: new Date().toISOString(),
                    selectedIndustry: selectedIndustry,
                    totalFiles: selectedFiles.length,
                    fileNames: selectedFiles.map(f => f.name)
                }
            };
            
            const json = JSON.stringify(exportData, null, 2);
            downloadFile(`workflow-data-${new Date().toISOString().slice(0, 19)}.json`, json, 'application/json');
        });

        // 파일 다운로드 헬퍼
        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // 기본 업종 선택
        document.querySelector('[data-industry="auto"]').click();
    </script>
</body>
</html>